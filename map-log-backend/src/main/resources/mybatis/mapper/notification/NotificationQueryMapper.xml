<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maplog.notification.query.mapper.NotificationQueryMapper">

    <select id="findNotifications"
            resultType="com.maplog.notification.query.dto.NotificationResponse">
        <!-- 알림 500 에러 수정을 위해 실제 DB 컬럼인 is_read를 조회하고 Java 객체 필드명인 read로 변환합니다. -->
        SELECT id, type, reference_id, message, is_read AS "read", created_at
        FROM notifications
        WHERE user_id = #{userId}
        <if test="readFilter != null">
            <!-- 조건절 검색 시에도 DTO 필드명이 아닌 실제 데이터베이스 컬럼명인 is_read를 통해 필터링합니다. -->
            AND is_read = #{readFilter}
        </if>
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countNotifications" resultType="long">
        SELECT COUNT(*)
        FROM notifications
        WHERE user_id = #{userId}
        <if test="readFilter != null">
            AND is_read = #{readFilter}
        </if>
    </select>

</mapper>
