<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
  일기 조회 전용 MyBatis 매퍼입니다. 
  복잡한 검색 조건, 통계, 다중 JOIN 연산 등을 고성능으로 처리하기 위해 SQL을 직접 관리합니다.
-->
<mapper namespace="com.maplog.diary.query.mapper.DiaryQueryMapper">

    <resultMap id="DiaryDetailResultMap"
               type="com.maplog.diary.query.dto.DiaryDetailResponse">
        <id     property="id"           column="diary_id"/>
        <result property="userId"       column="user_id"/>
        <result property="authorNickname" column="author_nickname"/>
        <result property="title"        column="title"/>
        <result property="content"      column="content"/>
        <result property="latitude"     column="latitude"/>
        <result property="longitude"    column="longitude"/>
        <result property="locationName" column="location_name"/>
        <result property="address"      column="address"/>
        <result property="visitedAt"    column="visited_at"/>
        <result property="visibility"   column="visibility"/>
        <result property="createdAt"    column="created_at"/>
        <result property="scraped"      column="scraped"/>
        <!-- 일기에 포함된 다중 이미지를 Collection으로 매핑 (1:N) -->
        <collection property="images"
                    ofType="com.maplog.diary.query.dto.DiaryImageResponse">
            <id     property="imageId"  column="image_id"/>
            <result property="imageUrl" column="image_url"/>
        </collection>
    </resultMap>

    <!-- 일기 상세 조회: 일기 기본정보 + 작성자 닉네임 + 스크랩 여부 + 이미지 목록을 한 번에 JOIN -->
    <select id="findDiaryDetail" resultMap="DiaryDetailResultMap">
        SELECT
            d.id          AS diary_id,
            d.user_id     AS user_id,
            u.nickname    AS author_nickname,
            d.title,
            d.content,
            d.latitude,
            d.longitude,
            d.location_name,
            d.address,
            d.visited_at,
            d.visibility,
            d.created_at,
            CASE WHEN s.id IS NOT NULL THEN TRUE ELSE FALSE END AS scraped,
            di.id         AS image_id,
            di.image_url  AS image_url
        FROM diaries d
        INNER JOIN users u ON u.id = d.user_id
        LEFT JOIN scraps s ON s.diary_id = d.id AND s.user_id = #{userId}
        LEFT JOIN diary_images di ON di.diary_id = d.id
        WHERE d.id = #{diaryId}
          AND d.deleted_at IS NULL
    </select>

    <!-- 지도 마커 조회: 위도/경도 범위 내의 일기 중 '내 것' 혹은 '공유받은 것'만 필터링 -->
    <select id="findMapMarkers"
            resultType="com.maplog.diary.query.dto.DiaryMarkerResponse">
        SELECT d.id, d.latitude, d.longitude, d.title, d.location_name
        FROM diaries d
        LEFT JOIN diary_shares ds ON ds.diary_id = d.id AND ds.user_id = #{userId}
        WHERE d.latitude  BETWEEN #{minLat} AND #{maxLat}
          AND d.longitude BETWEEN #{minLng} AND #{maxLng}
          AND d.deleted_at IS NULL
          AND (
            d.user_id = #{userId} 
            OR (d.visibility = 'FRIENDS_ONLY' AND ds.id IS NOT NULL)
          )
    </select>

    <!-- 내 일기 목록 조회 (페이징 적용) -->
    <select id="findMyDiaries"
            resultType="com.maplog.diary.query.dto.DiarySummaryResponse">
        SELECT id, title, location_name, visited_at, visibility, created_at
        FROM diaries
        WHERE user_id = #{userId}
          AND deleted_at IS NULL
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 피드 조회: 내가 공유받은 친구의 일기만 최신순으로 조회 -->
    <select id="findFeedDiaries" resultType="com.maplog.diary.query.dto.DiarySummaryResponse">
        SELECT d.id, d.title, d.location_name, d.visited_at, d.visibility, d.created_at, u.nickname as authorNickname
        FROM diaries d
        INNER JOIN users u ON u.id = d.user_id
        INNER JOIN diary_shares ds ON ds.diary_id = d.id
        WHERE ds.user_id = #{userId}
          AND d.deleted_at IS NULL
          AND d.visibility = 'FRIENDS_ONLY'
        ORDER BY d.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

</mapper>